name: CI_Testing

on:
  push:
    branches:
      - main
      - 'feature/**'
  pull_request:

jobs:
  rspec:
    name: RSpec
    runs-on: ubuntu-latest
    env:
      RAILS_ENV: test
      # Dummy Keys for testing purposes from test.rb
      SECRET_KEY_BASE: "test_only_change_in_prod"
      AR_ENC_PRIMARY_KEY: "00000000000000000000000000000000"
      AR_ENC_DETERMINISTIC_KEY: "11111111111111111111111111111111"
      AR_ENC_SALT: "salt-salt-salt-salt"
    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Prepare DB
        run: bin/rails db:prepare

      - name: Run RSpec
        env:
          TERM: xterm-256color
          FORCE_COLOR: "1"
          CLICOLOR_FORCE: "1"
        run: |
            echo "::group::RSpec"
            bundle exec rspec --color
            echo "::endgroup::"
  
  discover-features:
    runs-on: ubuntu-latest
    outputs:
      feature_matrix: ${{ steps.collect.outputs.feature_matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Collect .feature files
        id: collect
        shell: bash
        run: |
          set -euo pipefail

          mapfile -d '' files < <(
            { find ./features -type f -name "*.feature" -print0 2>/dev/null || true; \
              find ./feature  -type f -name "*.feature" -print0 2>/dev/null || true; } \
            | sort -z
          )

          if [ ${#files[@]} -eq 0 ]; then
            json='[]'
          else
            # Make JSON objects: {path: "features/x.feature", name: "x.feature"}
            json=$(printf '%s\0' "${files[@]}" \
              | sed -z 's#^\./##g' \
              | jq -Rs 'split("\u0000")[:-1] | map({path: ., name: ( . | split("/") | last )})')
          fi

          echo "feature_matrix<<EOF" >> "$GITHUB_OUTPUT"
          echo "$json" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
  
  cucumber:
    name: Cucumber-${{ matrix.name }}
    runs-on: ubuntu-latest
    needs: 
      - discover-features
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.discover-features.outputs.feature_matrix) }}
    env:
      RAILS_ENV: test
      SECRET_KEY_BASE: "test_only_change_in_prod"
      AR_ENC_PRIMARY_KEY: "00000000000000000000000000000000"
      AR_ENC_DETERMINISTIC_KEY: "11111111111111111111111111111111"
      AR_ENC_SALT: "salt-salt-salt-salt"
    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Prepare DB
        run: bin/rails db:prepare

      - name: Run Cucumber
        env:
          TERM: xterm-256color
          FORCE_COLOR: "1"
          CLICOLOR_FORCE: "1"
        run: |
            echo "::group::${{ matrix.name }}"
            bundle exec cucumber --color "${{ matrix.path }}"
            echo "::endgroup::"