name: Coverage Report

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  simplecov:
    name: Publish SimpleCov HTML
    runs-on: ubuntu-latest
    env:
      RAILS_ENV: test
      SECRET_KEY_BASE: "test_only_change_in_prod"
      AR_ENC_PRIMARY_KEY: "00000000000000000000000000000000"
      AR_ENC_DETERMINISTIC_KEY: "11111111111111111111111111111111"
      AR_ENC_SALT: "salt-salt-salt-salt"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Prepare DB
        run: bin/rails db:prepare

      - name: Run RSpec with coverage
        env:
          TERM: xterm-256color
          FORCE_COLOR: "1"
          CLICOLOR_FORCE: "1"
        run: |
          echo "::group::RSpec"
          bundle exec rspec --color
          echo "::endgroup::"

      - name: Run Cucumber with coverage
        env:
          TERM: xterm-256color
          FORCE_COLOR: "1"
          CLICOLOR_FORCE: "1"
        run: |
          echo "::group::Cucumber"
          bundle exec cucumber --color
          echo "::endgroup::"

      - name: Publish coverage to gh-pages/docs
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: coverage
          destination_dir: docs
