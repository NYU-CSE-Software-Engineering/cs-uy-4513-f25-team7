<div class="forum-container">
  <div class="forum-header">
    <h1>Forum</h1>
    <%= link_to 'New Post', new_post_path, class: 'btn btn-primary' %>
  </div>

  <div class="search-filters">
    <%= form_with url: posts_path, method: :get, local: true, class: 'search-form' do |form| %>
      <div class="search-row">
        <%= form.text_field :search, placeholder: 'Search posts...', value: @search, class: 'search-input', id: 'search' %>
        <% if @all_tags.present? %>
          <%= form.select :tag, options_from_collection_for_select(@all_tags, :name, :name, @tag_filter),
                          { prompt: 'Filter by tag...', include_blank: true }, { class: 'tag-filter', id: 'tag' } %>
        <% end %>
        <%= form.submit 'Search', class: 'btn btn-secondary' %>
        <%= link_to 'Clear', posts_path, class: 'btn btn-outline' %>
      </div>
    <% end %>
  </div>

  <% if @popular_tags.present? %>
    <div class="popular-tags">
      <h3>Popular Tags</h3>
      <div class="tag-list">
        <% @popular_tags.each do |tag| %>
          <div class="tag-item">
            <%= link_to tag.name, posts_path(tag: tag.name), class: 'tag' %>
            <span class="tag-stats">(<%= tag.posts.count %> posts)</span>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <div class="posts-list">
    <% if @posts.present? %>
      <% @posts.each do |post| %>
        <div class="post-card">
          <% if ActiveRecord::Base.connection.table_exists?('votes') && defined?(upvote_post_path) %>
            <div class="post-voting" data-controller="voting" data-voting-post-id-value="<%= post.id %>">
              <%= form_with url: upvote_post_path(post), method: :post, local: Rails.env.test?, class: 'vote-form' do |form| %>
                <%= form.submit '▲', class: 'vote-btn upvote-btn', data: { action: 'click->voting#upvote' } %>
              <% end %>
              
              <span class="vote-score" data-voting-target="score" data-post-id="<%= post.id %>">
                <%= post.vote_score rescue 0 %>
              </span>
              
              <%= form_with url: downvote_post_path(post), method: :post, local: Rails.env.test?, class: 'vote-form' do |form| %>
                <%= form.submit '▼', class: 'vote-btn downvote-btn', data: { action: 'click->voting#downvote' } %>
              <% end %>
            </div>
          <% end %>
          
          <div class="post-content">
            <h3><%= link_to post.title, post_path(post), class: 'post-title' %></h3>
            <p class="post-preview"><%= truncate(post.body, length: 200) %></p>
            <div class="post-meta">
              <% if ActiveRecord::Base.connection.table_exists?('tags') && post.respond_to?(:tags) && post.tags.any? %>
                <div class="post-tags">
                  <% post.tags.each do |tag| %>
                    <%= link_to tag.name, posts_path(tag: tag.name), class: 'tag' %>
                  <% end %>
                </div>
              <% end %>
              <div class="post-info">
                <span class="post-date"><%= post.created_at&.strftime('%B %d, %Y at %I:%M %p') || 'Date not available' %></span>
              </div>
            </div>
          </div>
        </div>
      <% end %>
      
      <% if @posts.respond_to?(:total_pages) && @posts.total_pages > 1 %>
        <div class="pagination">
          <% begin %>
            <%= paginate @posts %>
          <% rescue NoMethodError, NameError %>
            <!-- Pagination not available -->
          <% end %>
        </div>
      <% end %>
    <% else %>
      <div class="no-posts">
        <p>No posts found. <%= link_to 'Create the first post!', new_post_path %></p>
      </div>
    <% end %>
  </div>
</div>
