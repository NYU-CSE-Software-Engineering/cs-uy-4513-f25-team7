<div data-test="species-page" style="max-width: 900px; margin: 0 auto;">
  <!-- Species Header Card -->
  <div class="card" style="text-align: center; padding: 2rem; margin-bottom: 2rem;">
    <% if @sprite_url.present? %>
      <div data-test="species-sprite" style="margin-bottom: 1rem;">
        <img src="<%= @sprite_url %>"
             alt="<%= @name %> sprite"
             style="image-rendering: pixelated; width: 120px; height: 120px; filter: drop-shadow(0 0 10px var(--accent-glow));">
      </div>
    <% end %>

    <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem;"><%= @name %></h1>
    
    <div data-test="follower-count" class="text-muted" style="margin-bottom: 1.5rem;">
      <span style="font-size: 1.25rem;"><%= @follower_count %></span> <%= "follower".pluralize(@follower_count) %>
    </div>

    <div>
      <% if @following %>
        <%= button_to "üíî Unfollow",
                      species_follow_path(name: @name),
                      method: :delete,
                      class: "btn btn-secondary",
                      "data-test": "follow-button" %>
      <% else %>
        <%= button_to "‚ù§Ô∏è Follow",
                      species_follow_path(name: @name),
                      method: :post,
                      class: "btn btn-primary",
                      "data-test": "follow-button" %>
      <% end %>
    </div>
  </div>

  <!-- Discussion Forum Section -->
  <div data-test="species-discussion">
    <h2>üí¨ Discussion</h2>

    <% if user_signed_in? %>
      <div class="card" style="margin-bottom: 2rem;">
        <h4 style="margin-bottom: 1rem;">Start a Discussion about <%= @name %></h4>
        <%= form_with model: @new_post, url: species_posts_path(name: @name), local: true do |f| %>
          <% if @new_post&.errors&.any? %>
            <div class="flash alert" style="margin-bottom: 1rem;">
              <% @new_post.errors.full_messages.each do |msg| %>
                <p style="margin: 0;"><%= msg %></p>
              <% end %>
            </div>
          <% end %>

          <div class="form-group">
            <%= f.label :title %>
            <%= f.text_field :title, placeholder: "What's on your mind about #{@name}?" %>
          </div>

          <div class="form-group">
            <%= f.label :post_type, "Category" %>
            <%= f.select :post_type, [
              ["‚öîÔ∏è Strategy", "Strategy"],
              ["üí¨ Thread", "Thread"],
              ["üìä Meta", "Meta"]
            ] %>
          </div>

          <div class="form-group">
            <%= f.label :body, "Your thoughts" %>
            <%= f.text_area :body, rows: 4, placeholder: "Share your thoughts, strategies, or questions..." %>
          </div>

          <%= f.submit "Post Discussion", class: "btn btn-primary" %>
        <% end %>
      </div>
    <% else %>
      <div class="card text-center" style="padding: 2rem; margin-bottom: 2rem;">
        <p class="text-muted" style="margin: 0;">
          <%= link_to "Log in", new_user_session_path %> to join the discussion about <%= @name %>.
        </p>
      </div>
    <% end %>

    <% if @posts.any? %>
      <div data-test="species-posts">
        <% @posts.each do |post| %>
          <div class="post-card">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
              <div style="flex: 1;">
                <h4 style="margin-bottom: 0.5rem;">
                  <%= link_to post.title, post_path(post) %>
                  <span class="post-type-badge <%= post.post_type.downcase %>"><%= post.post_type %></span>
                </h4>
                <p class="text-muted text-small" style="margin-bottom: 0.75rem;">
                  by <strong><%= post.user.display_name %></strong>
                  ¬∑ <%= time_ago_in_words(post.created_at) %> ago
                  ¬∑ <%= post.comments.count %> <%= "comment".pluralize(post.comments.count) %>
                </p>
                <p class="text-secondary" style="margin: 0;"><%= truncate(post.body, length: 200) %></p>
              </div>
              <%= link_to "View ‚Üí", post_path(post), class: "btn btn-secondary btn-small", style: "margin-left: 1rem;" %>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="card text-center" style="padding: 3rem;">
        <p style="font-size: 3rem; margin-bottom: 1rem;">üó®Ô∏è</p>
        <h3>No discussions yet!</h3>
        <p class="text-muted">Be the first to start a conversation about <%= @name %>.</p>
      </div>
    <% end %>
  </div>

  <div style="margin-top: 2rem;">
    <%= link_to "‚Üê Back to Species Search", species_index_path, class: "btn btn-secondary" %>
  </div>
</div>
