<h1><%= @team.name %></h1>

<% if user_signed_in? %>
  <% if @favorite %>
    <%= button_to "Favorited", favorite_path(@favorite), method: :delete, form: { data: { turbo: false } } %>
  <% else %>
    <%= button_to "Favorite", favorites_path, params: { favoritable_type: @team.class.name, favoritable_id: @team.id }, method: :post, form: { data: { turbo: false } } %>
  <% end %>
<% end %>

<p>
  <% if @team.draft? %>
    <span class="badge">Draft</span>
  <% else %>
    <span class="badge">Published</span>
  <% end %>
  &mdash;
  <span>Visibility: <%= @team.visibility_label %></span>
</p>

<p>
  Legality:
  <% if @team.legal? %>
    <span class="badge badge-legal">Legal</span>
  <% else %>
    <span class="badge badge-illegal">Illegal</span>
  <% end %>
</p>

<p>
  Owner:
  <span><%= @team.user&.display_name || "Unknown" %></span>
</p>

<p>
  Shareable URL: <%= team_url(@team) %>
</p>

<!-- Rating Summary -->
<%= render "reviews/summary", team: @team %>

<hr>

<h2>Pok√©mon</h2>
<% @team.team_slots.each do |slot| %>
  <div class="team-slot" id="slot-<%= slot.slot_index %>" data-slot="<%= slot.slot_index %>">
    <h3>Slot <%= slot.slot_index %> - <%= slot.species.presence || "(empty)" %></h3>
    <% if slot.illegal? %>
      <span class="badge badge-illegal">Illegal</span>
    <% else %>
      <span class="badge badge-legal">Legal</span>
    <% end %>
  </div>
<% end %>

<hr>

<!-- Reviews Section -->
<h2>Reviews</h2>

<% if @team.published? && @team.public_team? %>
  <% if user_signed_in? %>
    <% existing_review = @team.reviews.visible.find_by(user: current_user) %>
    <% if @team.user != current_user %>
      <% if existing_review %>
        <div class="existing-review">
          <p><strong>Your Review:</strong></p>
          <%= render "reviews/review", review: existing_review, team: @team, show_actions: true %>
        </div>
      <% else %>
        <%= render "reviews/form", team: @team, review: Review.new %>
      <% end %>
    <% else %>
      <p class="info-message">You cannot review your own team.</p>
    <% end %>
  <% else %>
    <p><%= link_to "Log in", new_user_session_path %> to leave a review.</p>
  <% end %>

  <hr>

  <% visible_reviews = @team.reviews.visible.by_recent.where.not(user: current_user) %>
  <% if visible_reviews.any? %>
    <div class="reviews-list">
      <% visible_reviews.each do |review| %>
        <%= render "reviews/review", review: review, team: @team, show_actions: (user_signed_in? && (current_user.moderator? || current_user.admin?)) %>
      <% end %>
    </div>
  <% elsif @team.reviews.visible.count == 0 %>
    <p class="empty-state">No reviews yet. Be the first to review this team!</p>
  <% end %>
<% else %>
  <p class="info-message">Reviews are only available for published public teams.</p>
<% end %>
